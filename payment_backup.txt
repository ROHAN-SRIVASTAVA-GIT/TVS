const Payment = require('../models/Payment');
const { getPhonePeClient, Env } = require('../config/phonepe');
const { paymentValidator, paymentVerificationValidator } = require('../validators/payment.validator');
const { CreateSdkOrderRequest, MetaInfo } = require('phonepe-pg-sdk-node');
const { randomUUID } = require('crypto');
const logger = require('../config/logger');

class PaymentController {
  static async createOrder(req, res) {
    try {
      console.log('=== PhonePe Payment Create Order Started ===');
      console.log('Request body:', JSON.stringify(req.body, null, 2));
      
      const { error, value } = paymentValidator(req.body);
      
      if (error) {
        console.log('Validation error:', error.details);
        return res.status(400).json({
          success: false,
          message: 'Validation failed',
          errors: error.details.map(e => e.message)
        });
      }

      const amountInPaisa = Math.round(value.amount * 100);
      console.log('Amount in paisa:', amountInPaisa);

      const merchantOrderId = `ORDER_${Date.now()}_${randomUUID().substring(0, 8)}`;
      console.log('Merchant Order ID:', merchantOrderId);

      const redirectUrl = `${process.env.FRONTEND_URL || 'http://localhost:3000'}/payment-callback`;
      console.log('Redirect URL:', redirectUrl);

      const metaInfo = MetaInfo.builder()
        .udf1(value.studentName || '')
        .udf2(value.email || '')
        .udf3(value.phone || '')
        .udf4(value.feeType || '')
        .udf5(value.className || '')
        .build();

      console.log('MetaInfo built:', metaInfo);

      const request = CreateSdkOrderRequest.StandardCheckoutBuilder()
        .merchantOrderId(merchantOrderId)
        .amount(amountInPaisa)
        .redirectUrl(redirectUrl)
        .metaInfo(metaInfo)
        .expireAfter(3600)
        .message(`Fee Payment - ${value.feeType} - Class ${value.className}`)
        .build();

      console.log('PhonePe request built successfully');
      console.log('Request:', JSON.stringify(request, (key, val) => {
        if (val && val.toJSON) return val.toJSON();
        return val;
      }, 2));

      const client = getPhonePeClient();
      
      console.log('Creating PhonePe order...');
      const response = await client.createSdkOrder(request);
      
      console.log('PhonePe response:');
      console.log('- orderId:', response.orderId);
      console.log('- state:', response.state);
      console.log('- token:', response.token ? 'present' : 'not present');
      console.log('- redirectUrl:', response.redirectUrl);

      const userId = req.userId || null;

      const payment = await Payment.create({
        userId: userId,
        studentId: value.studentId || null,
        razorpayOrderId: merchantOrderId,
        phonepeOrderId: response.orderId,
        phonepeToken: response.token,
        amount: value.amount,
        feeType: value.feeType,
        academicYear: value.academicYear,
        className: value.className,
        notes: value.notes,
        status: 'pending'
      });

      console.log('Payment record created in DB with ID:', payment.id);
      logger.info(`PhonePe payment order created: ${merchantOrderId}, PhonePe Order ID: ${response.orderId}`);

      res.status(201).json({
        success: true,
        message: 'Payment order created successfully',
        data: {
          orderId: merchantOrderId,
          phonepeOrderId: response.orderId,
          token: response.token,
          redirectUrl: response.redirectUrl,
          amount: value.amount,
          currency: 'INR',
          paymentId: payment.id
        }
      });
    } catch (error) {
      console.error('=== PhonePe Create Order ERROR ===');
      console.error('Error name:', error.name);
      console.error('Error message:', error.message);
      console.error('Error code:', error.code);
      console.error('Error stack:', error.stack);
      console.error('====================================');
      logger.error('PhonePe Create order error:', error);
      
      res.status(500).json({
        success: false,
        message: 'Failed to create payment order',
        error: error.message
      });
    }
  }

  static async verifyPayment(req, res) {
    try {
      console.log('=== PhonePe Payment Verification Started ===');
      console.log('Request body:', req.body);

      const { merchantOrderId, phonepeOrderId } = req.body;

      if (!merchantOrderId && !phonepeOrderId) {
        return res.status(400).json({
          success: false,
          message: 'Order ID is required'
        });
      }

      const client = getPhonePeClient();
      const orderIdToCheck = phonepeOrderId || merchantOrderId;

      console.log('Checking order status for:', orderIdToCheck);
      
      const response = await client.getOrderStatus(orderIdToCheck, false);

      console.log('Order status response:');
      console.log('- orderId:', response.orderId);
      console.log('- state:', response.state);
      console.log('- amount:', response.amount);
      console.log('- paymentDetails:', response.paymentDetails?.length || 0);

      const state = response.state;
      let paymentStatus = 'pending';
      let transactionId = null;
      let paymentMode = null;

      if (state === 'COMPLETED') {
        paymentStatus = 'completed';
        if (response.paymentDetails && response.paymentDetails.length > 0) {
          const latestPayment = response.paymentDetails[0];
          transactionId = latestPayment.transactionId;
          paymentMode = latestPayment.paymentMode;
        }
      } else if (state === 'FAILED') {
        paymentStatus = 'failed';
      }

      const payment = await Payment.updateByOrderId(orderIdToCheck, {
        razorpayPaymentId: transactionId,
        status: paymentStatus,
        paymentMethod: paymentMode || 'phonepe',
        transactionDate: new Date()
      });

      console.log('Payment updated in DB:', paymentStatus);
      logger.info(`PhonePe payment verified: ${orderIdToCheck}, State: ${state}`);

      res.status(200).json({
        success: true,
        message: paymentStatus === 'completed' ? 'Payment verified successfully' : 'Payment not completed',
        data: {
          state: state,
          paymentStatus: paymentStatus,
          transactionId: transactionId,
          amount: response.amount / 100
        }
      });
    } catch (error) {
      console.error('=== PhonePe Verify Payment ERROR ===');
      console.error('Error:', error.message);
      console.error('=====================================');
      logger.error('PhonePe verify payment error:', error);
      
      res.status(500).json({
        success: false,
        message: 'Failed to verify payment',
        error: error.message
      });
    }
  }

  static async getPaymentHistory(req, res) {
    try {
      const limit = req.query.limit || 20;
      const offset = req.query.offset || 0;

      const result = await Payment.findByUserId(req.userId, limit, offset);

      res.status(200).json({
        success: true,
        data: result
      });
    } catch (error) {
      logger.error('Fetch payment history error:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to fetch payment history'
      });
    }
  }

  static async getPaymentDetails(req, res) {
    try {
      const { orderId } = req.params;
      const payment = await Payment.findByOrderId(orderId);

      if (!payment || (payment.user_id !== req.userId && req.userRole !== 'admin')) {
        return res.status(404).json({
          success: false,
          message: 'Payment not found'
        });
      }

      res.status(200).json({
        success: true,
        data: payment
      });
    } catch (error) {
      logger.error('Fetch payment details error:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to fetch payment details'
      });
    }
  }

  static async getPaymentStats(req, res) {
    try {
      const stats = await Payment.getPaymentStats();

      res.status(200).json({
        success: true,
        data: stats
      });
    } catch (error) {
      logger.error('Fetch payment stats error:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to fetch payment stats'
      });
    }
  }

  static async manualPaymentSubmit(req, res) {
    try {
      console.log('=== Manual Payment Submission Started ===');
      
      const { studentId, studentName, email, phone, amount, feeType, className, academicYear, notes } = req.body;
      
      const screenshotUrl = req.file ? `/uploads/payments/${req.file.filename}` : null;

      console.log('Manual payment data:', {
        studentName, email, phone, amount, feeType, className, screenshotUrl
      });

      const payment = await Payment.create({
        userId: null,
        studentId: studentId || null,
        studentName: studentName,
        parentEmail: email,
        parentPhone: phone,
        razorpayOrderId: `MANUAL_${Date.now()}`,
        amount: parseFloat(amount),
        feeType: feeType,
        academicYear: academicYear,
        className: className,
        notes: notes,
        paymentType: 'manual',
        status: 'pending_verification',
        screenshotUrl: screenshotUrl
      });

      console.log('Manual payment created:', payment.id);
      logger.info(`Manual payment submitted: ${payment.id}`);

      res.status(201).json({
        success: true,
        message: 'Payment screenshot uploaded successfully. We will verify and confirm shortly.',
        data: {
          paymentId: payment.id,
          amount: amount,
          status: 'pending_verification'
        }
      });
    } catch (error) {
      console.error('Manual payment error:', error);
      logger.error('Manual payment submission error:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to submit payment',
        error: error.message
      });
    }
  }

  static async getAllPayments(req, res) {
    try {
      const limit = parseInt(req.query.limit) || 50;
      const offset = parseInt(req.query.offset) || 0;
      const status = req.query.status;
      const paymentType = req.query.type;

      const result = await Payment.getAll(limit, offset, status, paymentType);

      res.status(200).json({
        success: true,
        data: result
      });
    } catch (error) {
      logger.error('Fetch all payments error:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to fetch payments'
      });
    }
  }

  static async generateReceipt(req, res) {
    try {
      const { id } = req.params;
      const payment = await Payment.findById(id);

      if (!payment) {
        return res.status(404).json({
          success: false,
          message: 'Payment not found'
        });
      }

      const receiptHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Payment Receipt - Top View Public School</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; background: #f5f5f5; }
    .receipt { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 30px; text-align: center; }
    .header h1 { font-size: 28px; margin-bottom: 5px; }
    .header p { opacity: 0.9; font-size: 14px; }
    .body { padding: 30px; }
    .section { margin-bottom: 25px; }
    .section-title { color: #1a1a2e; font-size: 16px; font-weight: 600; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #667eea; }
    .row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .row:last-child { border-bottom: none; }
    .label { color: #666; font-size: 14px; }
    .value { color: #1a1a2e; font-weight: 500; font-size: 14px; }
    .amount { color: #28a745; font-size: 24px; font-weight: 700; }
    .status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status.pending { background: #fff3cd; color: #856404; }
    .status.completed { background: #d4edda; color: #155724; }
    .status.failed { background: #f8d7da; color: #721c24; }
    .footer { background: #f8f9fa; padding: 20px; text-align: center; color: #666; font-size: 12px; }
    .print-btn { display: block; margin: 20px auto; padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .print-btn:hover { background: #5568d3; }
    @media print { body { padding: 0; } .print-btn { display: none; } }
  </style>
</head>
<body>
  <div class="receipt">
    <div class="header">
      <h1>Top View Public School</h1>
      <p>Manju Sadan Basdiha, Panki, Palamu, Jharkhand 822122</p>
      <p>Email: topviewpublicschool@gmail.com | Phone: 9470525155</p>
    </div>
    <div class="body">
      <div class="section">
        <div class="section-title">Payment Details</div>
        <div class="row">
          <span class="label">Receipt No.</span>
          <span class="value">TVPS/P/${String(${payment.id}).padStart(6, '0')}</span>
        </div>
        <div class="row">
          <span class="label">Transaction ID</span>
          <span class="value">${payment.phonepe_order_id || payment.razorpay_order_id || 'N/A'}</span>
        </div>
        <div class="row">
          <span class="label">Payment Date</span>
          <span class="value">${new Date(payment.created_at).toLocaleDateString('en-IN', { day: '2-digit', month: 'long', year: 'numeric' })}</span>
        </div>
        <div class="row">
          <span class="label">Payment Type</span>
          <span class="value">${payment.payment_type === 'online' ? 'Online Payment' : 'Manual Payment'}</span>
        </div>
        <div class="row">
          <span class="label">Status</span>
          <span class="value"><span class="status ${payment.status}">${payment.status.toUpperCase()}</span></span>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">Student Information</div>
        <div class="row">
          <span class="label">Student Name</span>
          <span class="value">${payment.student_name || 'N/A'}</span>
        </div>
        <div class="row">
          <span class="label">Class</span>
          <span class="value">${payment.class || 'N/A'}</span>
        </div>
        <div class="row">
          <span class="label">Academic Year</span>
          <span class="value">${payment.academic_year || 'N/A'}</span>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">Fee Details</div>
        <div class="row">
          <span class="label">Fee Type</span>
          <span class="value">${(payment.fee_type || '').charAt(0).toUpperCase() + (payment.fee_type || '').slice(1)} Fee</span>
        </div>
        <div class="row">
          <span class="label">Parent Email</span>
          <span class="value">${payment.parent_email || 'N/A'}</span>
        </div>
        <div class="row">
          <span class="label">Parent Phone</span>
          <span class="value">${payment.parent_phone || 'N/A'}</span>
        </div>
      </div>
      
      <div class="section">
        <div class="row">
          <span class="label" style="font-size: 18px; font-weight: 600;">Total Amount Paid</span>
          <span class="amount">â‚¹${parseFloat(payment.amount).toLocaleString('en-IN')}</span>
        </div>
      </div>
    </div>
    <div class="footer">
      <p>This is a computer-generated receipt. No signature required.</p>
      <p>Generated on: ${new Date().toLocaleString('en-IN')}</p>
      <button class="print-btn" onclick="window.print()">Print Receipt</button>
    </div>
  </div>
</body>
</html>
      `;

      res.setHeader('Content-Type', 'text/html');
      res.send(receiptHTML);
    } catch (error) {
      console.error('Generate receipt error:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to generate receipt'
      });
    }
  }
}

module.exports = PaymentController;
